{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nObject.defineProperty(exports, \"proxyRequest\", {\n  enumerable: true,\n  get: function () {\n    return proxyRequest;\n  }\n});\nconst _url = /*#__PURE__*/_interop_require_default(require(\"url\"));\nconst _serverrouteutils = require(\"../../server-route-utils\");\nfunction _interop_require_default(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\nasync function proxyRequest(req, res, parsedUrl, upgradeHead, reqBody, proxyTimeout) {\n  const {\n    query\n  } = parsedUrl;\n  delete parsedUrl.query;\n  parsedUrl.search = (0, _serverrouteutils.stringifyQuery)(req, query);\n  const target = _url.default.format(parsedUrl);\n  const HttpProxy = require(\"next/dist/compiled/http-proxy\");\n  const proxy = new HttpProxy({\n    target,\n    changeOrigin: true,\n    ignorePath: true,\n    xfwd: true,\n    ws: true,\n    // we limit proxy requests to 30s by default, in development\n    // we don't time out WebSocket requests to allow proxying\n    proxyTimeout: proxyTimeout === null ? undefined : proxyTimeout || 30000\n  });\n  await new Promise((proxyResolve, proxyReject) => {\n    let finished = false;\n    // http-proxy does not properly detect a client disconnect in newer\n    // versions of Node.js. This is caused because it only listens for the\n    // `aborted` event on the our request object, but it also fully reads\n    // and closes the request object. Node **will not** fire `aborted` when\n    // the request is already closed. Listening for `close` on our response\n    // object will detect the disconnect, and we can abort the proxy's\n    // connection.\n    proxy.on(\"proxyReq\", proxyReq => {\n      res.on(\"close\", () => proxyReq.destroy());\n    });\n    proxy.on(\"proxyRes\", proxyRes => {\n      if (res.destroyed) {\n        proxyRes.destroy();\n      } else {\n        res.on(\"close\", () => proxyRes.destroy());\n      }\n    });\n    proxy.on(\"proxyRes\", (proxyRes, innerReq, innerRes) => {\n      const cleanup = err => {\n        // cleanup event listeners to allow clean garbage collection\n        proxyRes.removeListener(\"error\", cleanup);\n        proxyRes.removeListener(\"close\", cleanup);\n        innerRes.removeListener(\"error\", cleanup);\n        innerRes.removeListener(\"close\", cleanup);\n        // destroy all source streams to propagate the caught event backward\n        innerReq.destroy(err);\n        proxyRes.destroy(err);\n      };\n      proxyRes.once(\"error\", cleanup);\n      proxyRes.once(\"close\", cleanup);\n      innerRes.once(\"error\", cleanup);\n      innerRes.once(\"close\", cleanup);\n    });\n    proxy.on(\"error\", err => {\n      console.error(`Failed to proxy ${target}`, err);\n      if (!finished) {\n        finished = true;\n        proxyReject(err);\n        if (!res.destroyed) {\n          res.statusCode = 500;\n          res.end(\"Internal Server Error\");\n        }\n      }\n    });\n    // if upgrade head is present treat as WebSocket request\n    if (upgradeHead) {\n      proxy.on(\"proxyReqWs\", proxyReq => {\n        proxyReq.on(\"close\", () => {\n          if (!finished) {\n            finished = true;\n            proxyResolve(true);\n          }\n        });\n      });\n      proxy.ws(req, res, upgradeHead);\n      proxyResolve(true);\n    } else {\n      proxy.on(\"proxyReq\", proxyReq => {\n        proxyReq.on(\"close\", () => {\n          if (!finished) {\n            finished = true;\n            proxyResolve(true);\n          }\n        });\n      });\n      proxy.web(req, res, {\n        buffer: reqBody\n      });\n    }\n  });\n}","map":{"version":3,"names":["proxyRequest","req","res","parsedUrl","upgradeHead","reqBody","proxyTimeout","query","search","_serverrouteutils","stringifyQuery","target","_url","default","format","HttpProxy","require","proxy","changeOrigin","ignorePath","xfwd","ws","undefined","Promise","proxyResolve","proxyReject","finished","on","proxyReq","destroy","proxyRes","destroyed","innerReq","innerRes","cleanup","err","removeListener","once","console","error","statusCode","end","web","buffer"],"sources":["../../../../src/server/lib/router-utils/proxy-request.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}